process.executor = 'local'

// Define the required input parameters
params.organism = "homo_sapiens"
params.census_version = "2024-07-01" // version of cellxgene census scvi model and data corpus for reference data
params.tree_file = "$projectDir/meta/master_hierarchy.json" // hierarchy to aggregate predicted classes
params.ref_keys = ["rachel_subclass", "rachel_class", "rachel_family"]  // transferred labels to evaluate
params.subsample_ref = 5 // number of cells per cell type in ref to sample
params.subsample_query = 100 // number of total cells in query to sample
params.relabel_r = "$projectDir/meta/census_map_human.tsv" // harmonized label mapping for references
params.relabel_q = "$projectDir/meta/*_relabel.tsv" // pattern to match multiple relabel files for queries
params.cutoff = 0 // do not threshold class probabilities 
params.remove_unknown = false
params.queries_adata= "$projectDir/queries/*h5ad"

// batch keys for scvi integration, must be columns in existing metadata
params.batch_keys = [
  "lau": "sample",
  "pineda": "Batch",
  "lim": "batch",
  "velmeshev": "sample",
  "rosmap": "batch", //old = projid, add string prefix
  "nagy": "batch" //old = orig.ident, addstring prefix
]  

params.ref_split= "tissue"
params.ref_collections = ["Transcriptomic cytoarchitecture reveals principles of human neocortex organization", "SEA-AD: Seattle Alzheimerâ€™s Disease Brain Cell Atlas"]
params.integration_method = "pcaproject"
params.dims = 50
params.max_features = 200
params.k_anchor = 10 
params.k_score = 30
params.k_weight = 20

params.outdir = "$projectDir/results/${params.organism}_ref_${params.subsample_ref}_query_${params.subsample_query}_cutoff_${params.cutoff}_refsplit_${params.ref_split}"  // Directory where outputs will be saved

// split columns and values for subsetting query

// params.subset_pairs = [
    // "lau"       : [["column1", "value1"], ["column2", "value2"]],
    // "pineda"    : [["column3", "value3"], ["column4", "value4"]],
    // "lim"       : [["Condition", "HD"], ["column6", "value6"]],
    // "velmeshev" : [["column7", "value7"], ["column8", "value8"]],
    // "rosmap"    : [["column9", "value9"], ["column10", "value10"]],
    // "nagy"      : [["column11", "value11"], ["column12", "value12"]]
// ]


process {
  cache = 'standard'  // Options: 'standard' (default), 'deep', 'lenient', or 'false'
}

nextflow {
  clean {
    afterRun = true  // Default is false; set to true to clean up automatically
  }
}

profiles {
  conda {
    conda.enabled = true
  }

  docker {
    process.container = 'raschwaa/census-pipeline:latest'
    docker.enabled = true
    runOptions = "-v $projectDir:/nextflow_eval_pipeline$projectDir -m 8g --memory-swap -1"
    temp = 'auto'
  }
}
